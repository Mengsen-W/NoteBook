# Unix 环境编程

## 1. 文件系统
---
---
### 1. vNode文件表项
1. 文件的操作依赖于文件描述符，在Unix中文件描述符是在一个文件的唯一标识。
2. 内核维护了一个打开文件表，存在在打开文件描述符和文件表项，显示的保存在 /dev/fd中。
3. 一个进程维护打开文件表，表项包括文件描述符和指向文件表项的指针，文件表项的指针由系统的打开文件表项维护。
4. 在一个Unix中，文件的操作包括以下几种
```c++
open()/openat() // 打开操作
                // 可以和creat()函数合并为一个原子操作
creat() // 创建文件
close() // 关闭文件，小心内存泄漏
read()/write()  // 读写操作
dup()/dup2()    // 复制文件描述符
sync()/fsync()/fdatasync()  // 磁盘存储方式
                            //是否经过缓冲区
                            //是否修改权限
lseek()                     // 修改当前文件偏移量
fcntl() // 改变打开文件的属性
ioctl() //IO操作的工具箱
```

---

### 2. iNode文件信息
- stat 第一个参数是文件名，第二个参数是传入数据的结构体，OS会把关于文件的信息写入这个结构体
- access 是检查文件权限的函数
- umask 设置屏蔽字
- chmod 修改文件访问权限
- chown 修改文件的组/用户id
- S_ISVTX 设置黏着位 常驻交换区
- truncate 文件扩展 不需要写操作
- link 创建硬链接
- unlink 实际上也是一个删除对于软硬连都适用
- rename 更改文件名
- symlink 软链接
- futimens/utimensat 修改文件时间
- mkdir/rmdir 创建/删除目录
- opendir/fdopendir/... 与文件操作类似
- chdir/getcwd 改变进程当前工作目录/得到工作目录绝对路径

1. Unix 中文件类型分为
    - 普通文件：内容是数据
    - 目录文件：包含其他文件名字及指向浙西文件的指针。对一个目录文件具有读权限的任一进程都可以读该目录的内容，但只有内核可以直接写目录文件。进程必须使用特定的函数才能更改目录。
    - 字符特殊文件：这种类型的文件提供对设备不带缓冲的访问，每次访问长度可变。系统中的所有设备要么是字符特殊文件，要么是块特殊文件。
    - 块特殊文件：这种类型的文件提供对设备（如磁盘）带缓冲的访问，每次访问以固定长度为单位进行。
    - FIFO：用于进程建通讯的文件，也称命名管道
    - 套接字文件：用于进程见的网络通讯
    - 符号链接：指向另一个文件
2. 用户组权限设置和用户权限设置
    - 在 st_mode 中设置两个位可以使程序在执行时的权限取决于文件所有(创建)用户/用户组的权限
    1. 第一个规则是，我们用名字打开任一类型的文件时，对该名字中包含的每一个目录，包括它可能隐含的当前工作目录都应具有执行权限。这就是为什么对于目录其执行权限位常被称为搜索位的原因, 也就是执行权限其实是涉及iNode改变的操作，写操作单纯的就是在写入。
3. 文件长度
    - 提供字段st_blksize和st_blocks。其中，第一个是对文件I/O较合适的块长度（包括空洞），第二个是所分配的实际512字节块块数（不包括空洞）
    - 这两个函数将一个现有文件长度截断为 length。如果该文件以前的长度大于 length，则超过length 以外的数据就不再能访问。如果以前的长度小于 length，文件长度将增加，在以前的文件尾端和新的文件尾端之间的数据将读作0（也就是可能在文件中创建了一个空洞）
3. 文件的逻辑系统：每一个磁盘分区分为
    - 自举块：用于引导
    - 超级块：在超级块中保存着文件系统的属性信息、磁盘布局和资源使用情况等信息。是对整个磁盘全局的概括
    - 一些柱面：保存用户或内核产生的数据
        - 超级块副本
        - 配置信息
        - i结点图维护所有i结点的信息，包括不限于i节点的类型
        - 块位图：维护数据块的信息
        - i节点信息：指向数据块，包含了文件有关的所有信息
        - 数据块：最终存放数据的位置
        - 目录块 存在i节点编号和文件名的关系
4. link
    - unlink的这种特性经常被程序用来确保即使是在程序崩溃时，它所创建的临时文件也不会遗留下来。进程用open或creat创建一个文件，然后立即调用unlink，因为该文件仍旧是打开的，所以不会将其内容删除。只有当进程关闭该文件或终止时（在这种情况下，内核关闭该进程所打开的全部文件），该文件的内容才被删除
    - 如果pathname是符号链接，那么unlink删除该符号链接，而不是删除由该链接所引用的文件。给出符号链接名的情况下，没有一个函数能删除由该链接所引用的文件。
    - 如果文件系统支持的话，超级用户可以调用unlink，其参数pathname指定一个目录，但是通常应当使用rmdir函数，而不使用unlink这种方式
    - 不能跨文件系统，不能硬链接目录
5. rename
    - 根据oldname是指文件、目录还是符号链接，有几种情况需要加以说明
6. symlink
    - readlink和readlinkat函数提供打开该只能读软链接本身，并读该链接中的名字，两个函数组合了 open、read 和 close 的所有操作。如果函数成功执行，则返回读入buf的字节数。在buf中返回的符号链接的内容不以null字节终止。
7. 文件时间
    - 修改时间（st_mtim）关于文件修改的时间
    - 状态更改时间（st_ctim）关于i节点更改的时间，如更改文件的访问权限、更改用户ID、更改链接数
    - 最后访问时间（st_atim）
8. 目录
    - 用rmdir函数可以删除一个空目录。空目录是只包含.和..这两项的目录。
    - 如果调用此函数使目录的链接计数成为 0，并且也没有其他进程打开此目录，则释放由此目录占用的空间
    - 如果在链接计数达到0时，有一个或多个进程打开此目录，则在此函数返回前删除最后一个链接及.和..项
    - 另外，在此目录中不能再创建新文件。但是在最后一个进程关闭它之前并不释放此目录。
    - 即使另一些进程打开该目录，它们在此目录下也不能执行其他操作
    - 这样处理的原因是，为了使rmdir函数成功执行，该目录必须是空的。
    - 为了防止文件系统产生混乱，只有内核才能写目录。一个目录的写权限位和执行权限位决定了在该目录中能否创建新文件以及删除文件，它们并不表示能否写目录本身。
9. 特殊文件 st_dev和st_rdev
    - 每个文件系统所在的存储设备都由其主、次设备号表示。设备号所用的数据类型是基本系统数据类型dev_t。主设备号标识设备驱动程序，有时编码为与其通信的外设板；次设备号标识特定的子设备。
    - 一个磁盘驱动器经常包含若干个文件系统。在同一磁盘驱动器上的各文件系统通常具有相同的主设备号，但是次设备号却不同。
    - 系统中与每个文件名关联的 st_dev 值是文件系统的设备号，该文件系统包含了这一文件名以及与其对应的i节点。
    - 只有字符特殊文件和块特殊文件才有st_rdev值。此值包含实际设备的设备号。
---

### 3. 标准IO
- 标准I/O库提供缓冲的目的是尽可能减少使用read和write调用的次数, 提供了一个缓冲区设定
- fwide--可用于设置流的定向，当最后一个参数为0时可以返回方向的信息
- setbuf-- 设定缓冲区
- fflush--冲洗缓冲区
- fopen--打开流
- getc/fgets--读流
- putc/fputs--写流
- fread/fwrite--二进制读写流
- ftell/fseek/ftello/fseeko/fgetpos/fsetpos 定位流
- printf格式化输出
- tmpnam/mkdtemp创建临时文件/目录
- fmemopen 内存流--所有的I/O都是通过在缓冲区与主存之间来回传送字节来完成的。我们将看到，即便这些流看起来像文件流，它们的某些特征使其更适用于字符串操作
---

### 4. 系统数据文件和信息
- UNIX 系统口令文件这些字段包含在<pwd.h>中定义的passwd结构中。
- struct passwd *getpwuid(uid_t uid)/struct passwd *getpwnam(const char *name)--返回登陆账号或姓名的口令文件
- truct passwd *getpwent(void)/void setpwent(void)/void endpwent(void)-- 直接查看登录的全部用户口令文件
- struct spwd *getspnam(const char *name)/struct spwd *getspent(void)/void setspent(void)/void endspent(void)--从阴影口令文件获得
- struct group *getgrgid(gid_t gid)/struct group *getgrnam(const char *name)/struct group *getgrent(void)/void setgrent(void)/void endgrent(void)--返回组文件信息
- int getgroups(int gidsetsize, gid_t grouplist[])/int setgroups(int ngroups, const gid_t grouplist[])/int initgroups(const char *username, gid_t basegid)--返回附属组文件信息
- utmp文件记录当前登录到系统的各个用户；wtmp文件跟踪各个登录和注销事件--char ut_line[8]/char ut_name[8]/long　ut_time;
- int uname(struct utsname *name)它返回与主机和操作系统有关的信息
- time_t time(time_t *calptr)--日历时间；int clock_gettime(clockid_t clock_id, struct timespec *tsp)--文件时间
---
